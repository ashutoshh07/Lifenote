<div class="h-full flex flex-col bg-system-color">

  <!-- Search Bar -->
  <div class="max-w-7xl mx-auto mt-3 px-6 w-full">
    <div class="relative search-bar">
      <input type="text" placeholder="Search notes..." [value]="searchQuery()" (input)="onSearch($event)" class="w-full pl-4 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg
               focus:ring-2 focus:ring-blue-500 focus:border-transparent
               bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white search-bar-input" />
    </div>
  </div>

  <!-- Inline Note Creator -->
  <div class="max-w-7xl mx-auto mt-3 px-6 w-full">
    <div class="inline-creator-container">
      @if (!isInlineCreatorExpanded()) {
      <div (click)="expandInlineCreator()" class="inline-creator-collapsed bg-gray-50 dark:bg-gray-700 rounded-lg border 
               border-gray-300 dark:border-gray-600 px-4 py-3 cursor-text
               hover:shadow-sm transition-all duration-200">
        <p class="text-gray-500 dark:text-gray-400 text-sm">Take a note...</p>
      </div>
      } @else {
      <!-- Expanded - NO blur events, click outside to save -->
      <div class="inline-creator-expanded bg-gray-50 dark:bg-gray-700 rounded-lg border 
                  border-gray-300 dark:border-gray-600 shadow-md animate-slide-down">
        <!-- Title Input - NO blur -->
        <input type="text" placeholder="Title" [(ngModel)]="inlineTitle" class="w-full px-4 py-3 text-base font-medium border-none focus:outline-none
                 bg-transparent text-gray-900 dark:text-white rounded-t-lg" autofocus />

        <!-- Content Textarea - NO blur -->
        <textarea placeholder="Take a note..." [(ngModel)]="inlineContent" rows="3" class="w-full px-4 py-2 text-sm border-none focus:outline-none resize-none
                 bg-transparent text-gray-900 dark:text-white"></textarea>

        <div class="px-4 py-2 text-xs text-gray-500 dark:text-gray-400">
          Click outside to save automatically
        </div>
      </div>
      }
    </div>
  </div>



  <!-- Notes Grid -->
  <div class="flex-1 overflow-y-auto px-6 py-6 mt-6">
    <div class="max-w-7xl mx-auto">

      @if (pinnedNotes().length > 0) {
      <div class="mb-8">
        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">
          Pinned
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          @for (note of pinnedNotes(); track note.id) {
          <app-note-card [note]="note" (clicked)="openEditNote($event)" (edit)="openEditNote($event)"
            (delete)="deleteNote($event)" (togglePin)="togglePin($event)" />
          }
        </div>
      </div>
      }

      @if (regularNotes().length > 0) {
      <div>
        <h2 class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">
          Notes
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          @for (note of regularNotes(); track note.id) {
          <app-note-card [note]="note" (clicked)="openEditNote($event)" (edit)="openEditNote($event)"
            (delete)="deleteNote($event)" (togglePin)="togglePin($event)" />
          }
        </div>
      </div>
      }

      @if (filteredNotes().length === 0 && !isInlineCreatorExpanded()) {
      <div class="flex flex-col items-center justify-center h-64 text-gray-500 dark:text-gray-400">
        <p class="text-lg">No notes yet</p>
        <p class="text-sm">Click "Take a note..." above to create your first note</p>
      </div>
      }
    </div>
  </div>

  <!-- FAB Button -->
  @if (showFAB()) {
  <button (click)="openNewNote()" class="fixed bottom-8 right-8 w-14 h-14 add-note-btn text-white rounded-full 
             shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-40">
    <lucide-icon [img]="PlusIcon" class="w-6 h-6"></lucide-icon>
  </button>
  }

  <!-- Clean Modal Editor -->
  @if (showEditor()) {
  <div class="modal-backdrop" [class.fullscreen]="isFullscreen()" (click)="onBackdropClick($event)">
    <div class="modal-content" [class.fullscreen-content]="isFullscreen()" (click)="$event.stopPropagation()">

      <!-- Circular Close Button (Top Right) -->
      <button (click)="closeEditor()" class="close-button">
        <lucide-icon [img]="CloseIcon" class="w-5 h-5"></lucide-icon>
      </button>

      <!-- Title (Editable, No Border) -->
      <input type="text" placeholder="Untitled" [(ngModel)]="editorTitle" class="note-title" />

      <!-- Content Area (Dynamic Height) -->
      <div class="note-content-wrapper">
        @if (isPreviewMode()) {
        <app-markdown-preview [content]="editorContent()" class="preview-area" />
        } @else {
        <textarea [(ngModel)]="editorContent" placeholder="Start typing..." class="note-textarea"></textarea>
        }
      </div>

      <!-- Floating Action Buttons (Bottom Right) -->
      <div class="floating-actions">
        <button (click)="togglePreview()" class="action-button" [title]="isPreviewMode() ? 'Edit' : 'Preview'">
          <lucide-icon [img]="isPreviewMode() ? EditIcon : EyeIcon" class="w-4 h-4"></lucide-icon>
        </button>

        <button (click)="toggleFullscreen()" class="action-button"
          [title]="isFullscreen() ? 'Exit fullscreen' : 'Fullscreen'">
          <lucide-icon [img]="FullscreenIcon" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

      <!-- Subtle Footer Hint -->
      <div class="footer-hint">
        Auto-saving â€¢ ESC to close
      </div>
    </div>
  </div>
  }
</div>